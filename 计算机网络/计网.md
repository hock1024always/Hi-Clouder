# DHCP（动态主机配置协议）

如果让我们自己填写上网的信息，我们需要配置

- 自己的IP地址（还要确保一个IP只能给一个人用）
- 子网掩码
- 网关地址
- DNS服务器地址

我们还要确保一台设备一个IP，不能有多台设备一个IP

这种是静态分配IP的方式适合服务器和打印机等静态设备（当然，这部分也不需要我们理解）

## 地址池与租期

DHCP分配的IP地址是局域网中的私有地址，这些地址发送东西的时候是要在路由器那里转化成公网IP发出去。

DHCP服务器在日常生活中就是路由器和光猫

**地址池：** 就是可以分配IP的方位，对于一些静态设备，我们需要一直使用的，就在地址池里面删除掉，这样就不会有移动设备动态的获取

**租期：** 就是设备**可以持有这个IP的时间（DHCP不会动态分配这个设备给其他设备的时间）**，如果我设置的是七天但是我只是用了一个小时，那么剩下这段时间这个IP是不会分配给其他设备的。同样，如果我使用静态设备的话，除了在地址池里面删除这个IP，还可以给租期设置成永久，这样效果是一样的。

## DHCP握手和网络模型

握手分成这几步：

![image-20251216180736140](D:\github\CloudNote\图片\云原生概念\image-20251216180736140.png)

### DHCP Discover

**DHCP是应用层协议**，下面介绍的是下层怎么封装

![image-20251216174846103](D:\github\CloudNote\图片\云原生概念\image-20251216174846103.png)

1. 传输层用UDP协议，端口如图（注意是不一样的）

2. 在网络层，我们不知道我们的IP（要不然就不会用这协议了），也不知道DHCP服务器的IP，所以像图中这样填是为了广播

3. 在数据链路层，这样填目标MAC也是为了广播

   ![image-20251216175129393](D:\github\CloudNote\图片\云原生概念\image-20251216175129393.png)

   - 理论上来说，设备发给交换机，然后交换机广播给其他设备实现数据包的发送
   - 但是在家，交换机和路由器是一体的，所以设备发送给路由器（起的是交换机的作用）之后，是不会发送给（打扰）其他设备的

当完成了发报之后，我们看一下网络安全部分的内容，如果有人一直恶意进行discover，理论上可以用掉地址池里面的所有IP

![image-20251216175502987](D:\github\CloudNote\图片\云原生概念\image-20251216175502987.png)

### DHCP offer

![image-20251216180024552](D:\github\CloudNote\图片\云原生概念\image-20251216180024552.png)

1. 传输层端口号和DHCP Discover是反过来的，因为发送方不一样了（图上好像没换过来），正确的是客户端（设备）67，服务端（路由器 DHCP服务器）68
2. 源、目的IP MAC发送如图，很好理解

我们要考虑一个特殊的情况，就是对于多台DHCP服务器的场景，他们都会给这个设备分一个IP，因此设备是需要选择的，因此要进行选择并请求（DHCP Request）

![image-20251216180129026](D:\github\CloudNote\图片\云原生概念\image-20251216180129026.png)

### DHCP Request

![image-20251216180450048](D:\github\CloudNote\图片\云原生概念\image-20251216180450048.png)

- 这一步和Discover有点像，都是广播

- 但是这步写明了选择的是哪个IP（看下面抓包对比一下就清楚了）

### DHCP ACK

这一步是和offer发送的很像，目的是确认客户端可以使用这个IP

## 抓包情况

![image-20251216180907722](D:\github\CloudNote\图片\云原生概念\image-20251216180907722.png)

### Discover

![image-20251216181324944](D:\github\CloudNote\图片\云原生概念\image-20251216181324944.png)

注意应用层报文的字段

- Transaction ID：客户端提供的随机数，如果有其他客户端也在使用DHCP，有这个参数方便判断属于哪个设备的请求

- 【Option：（50）】Request IP Address：这里面可以放之前用过的IP地址，表示客户端还想用

- 【Option：（55）】客户端想要什么都可以写在这里，但是DHCP服务器不一定都提供

  ![image-20251216181520391](D:\github\CloudNote\图片\云原生概念\image-20251216181520391.png)

### offer

![image-20251216182120172](D:\github\CloudNote\图片\云原生概念\image-20251216182120172.png)

- Your（client）IP address：服务器给客户的IP地址

- Next server IP address：家用填写的是当前路由器的地址

- Relay agent IP address：中继地址（处理DHCP服务器和客户端不在一个网段的情况）

- Option：客户端要的服务端不一定全提供（再强调一下）

  ![image-20251216182048378](D:\github\CloudNote\图片\云原生概念\image-20251216182048378.png)

### Request

![image-20251216182439258](D:\github\CloudNote\图片\云原生概念\image-20251216182439258.png)

这部分的报文和Discover非常像，基本上就是复制粘贴，但是下面这些参数要注意！！

- Option 50：这个请求的IP地址是选择的IP（一般会选择第一个收到的offer）
- 255.255.255.255（最上面四条的第三台）：还是会广播的发出去，这样其他DHCP服务器可以发现和自己给的不一样，选择的不是自己
- 参数列表里面还是会给Discover的复制过来，再乞求一次

### ACK

![image-20251216182949691](D:\github\CloudNote\图片\云原生概念\image-20251216182949691.png)

这个报文和DHCP offer一样，可以单播或者广播

# NAT协议

## 基础概念

这个协议相当于是在一个公网IP下面给每台设备分一个局域网IP

下面是IPv4分配的三个私网地址，任何组织都可以在其内部使用这些IP地址来组网，私网地址不可以直接访问互联网

![image-20251217100251113](D:\github\CloudNote\图片\云原生概念\image-20251217100251113.png)

### SNAT

源地址转换技术，为了解决局域网中两台设备路由相同而无法正常收发数据包

![image-20251217100817607](D:\github\CloudNote\图片\云原生概念\image-20251217100817607.png)

如果子网下两台设备的IP不一样，我们使用特殊标记来做区分（TCP协议用的是端口做区分）

![image-20251217094509673](D:\github\CloudNote\图片\云原生概念\image-20251217094509673.png)

下面是常见的特殊标记

![image-20251217094527117](D:\github\CloudNote\图片\云原生概念\image-20251217094527117.png)

### DNAT

外部请求请求的是一个端口，路由器将这个操作转化成 IP+端口 也就是一个网络服务

![image-20251217102408028](D:\github\CloudNote\图片\云原生概念\image-20251217102408028.png)

### 其他NAT

下面这部分是NAT协议相关的其他技术

![image-20251217100000404](D:\github\CloudNote\图片\云原生概念\image-20251217100000404.png)

## NAT模式（未完）

我们用`virtualbox`这个虚拟机

# 二层三层交换机

下面是最开始的网络连接

![image-20251217181648980](D:\github\CloudNote\图片\云原生概念\image-20251217181648980.png)

- 所有电脑都是连接到一起的，所有主机可以互联互通
- 一个位置可以用交换机拓展到多个主机

这样的网络存在问题，就是集线器只允许一个设备发送数据包，如果同时两台发送的话数据帧就会失效，而且每一次发送就干扰所有人，性能也太差了

## 二层交换机

首先，我们了解计算机网络的OSI模型

```
网络层            IP地址        （路由器以及三层交换机）
数据链路层         MAC地址       （交换机）
物理层            网线          （集线器）
```

那么我们就先来理解一下关于二层交换机使用的网络结构

![image-20251218104000071](D:\github\CloudNote\图片\云原生概念\image-20251218104000071.png)

1. 最开始，左侧的主机发送一个请求，找IP是xx的主机
   - 首先就是目标MAC全填f，使用ARP广播，发送数据帧抵达交换机
2. 交换机维护一个MAC与其端口的对应表，记录和更新这些记录（这也是其和集线器不同的地方所在）
3. 交换机如果不知道目标MAC是啥的话，就会泛洪，向各个端口发送数据帧
4. 目标主机收到消息之后，对比IP发现是自己，就回响应

注意，二层交换机处理不了IP地址，只能处理MAC地址

### VLAN

我们观察上面的结构，就会发现实际上所有的设备还是连在同一个网络下面的，这就意味着如果有人发送的是广播地址，就得泛洪。那么如果大家都这么搞，相当于整个网络无时无刻不在“发洪水”

因此，我们使用VLAN技术，把网络隔离成一个个虚拟局域网，各个**网段**之间没法发送消息（先这样简单理解）

![image-20251218105345084](D:\github\CloudNote\图片\云原生概念\image-20251218105345084.png)

## 三层交换机

要解决VLAN之间的通信问题，我们一般需要使用路由器来处理，但是成本有点高（毕竟路由器LAN口不多，而且其他功能也很多，浪费了），所以可以使用三层交换机来替代

![image-20251218110020967](D:\github\CloudNote\图片\云原生概念\image-20251218110020967.png)

### 对比

![image-20251218105705397](D:\github\CloudNote\图片\云原生概念\image-20251218105705397.png)

抽象图标解释

1. 喇叭：三层交换机比二层有更多的**广播域**
2. 表：三层交换机比二层交换机**速度**慢很多
3. 齿轮：三层交换机**配置难度**要比二层高

# ISCSI





